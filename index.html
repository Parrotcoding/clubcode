<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family:system-ui,Arial,sans-serif; margin:1rem auto; max-width:800px; }
    h1,h2 { color:#0c4a7f; }
    .quiz-list .quiz-link { cursor:pointer; color:#0366d6; text-decoration:underline; }
    .modal-backdrop {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    .modal {
      background:#fff; padding:2rem; max-width:600px; width:90%;
      max-height:90%; overflow:auto; position:relative;
    }
    .close-btn { position:absolute; top:.5rem; right:.5rem; cursor:pointer; }
    .progress { display:flex; gap:4px; margin-bottom:1rem; }
    .pill { flex:1; height:12px; background:#e2e8f0; border-radius:6px; }
    .pill.correct { background:#4caf50; }
    .pill.incorrect { background:#555; }
    .question { margin-bottom:1rem; }
    label { display:block; margin:.4rem 0; }
    button { padding:.5rem 1rem; margin-top:.5rem; }
  </style>
</head>
<body>
  <h1>HTML Fundamentals – Student Portal</h1>

  <section>
    <h2>Quizzes</h2>
    <div id="quizList">Loading quizzes…</div>
  </section>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <span id="closeModal" class="close-btn">✖️</span>
      <div id="quizContainer"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supa = supabase.createClient(
        'https://kqprtnxmostvagtildsn.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxcHJ0bnhtb3N0dmFndGlsZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MzkzNzcsImV4cCI6MjA2MTExNTM3N30.-vU2hAJuA7JLkRjj1iOBAN9Y0pDEr3DU4XKjEp7NOUc'
      );

      // Load quizzes
      const { data: quizzes = [] } = await supa
        .from('quizzes').select('id,title,grading_mode').eq('published', true).order('id');
      const list = document.getElementById('quizList');
      list.innerHTML = quizzes.map(q => `
        <div>
          <span class="quiz-link" data-id="${q.id}" data-mode="${q.grading_mode}">
            ${q.title}
          </span>
        </div>
      `).join('') || '<p>No quizzes available.</p>';

      // Modal
      const modal = document.getElementById('modalBackdrop');
      const container = document.getElementById('quizContainer');
      document.getElementById('closeModal').onclick = () => modal.style.display = 'none';

      // Launch quiz
      list.querySelectorAll('.quiz-link').forEach(el => {
        el.onclick = () => runQuiz(el.dataset.id, el.dataset.mode);
      });

      async function runQuiz(id, gradingMode) {
        modal.style.display = 'flex';
        container.innerHTML = '<p>Loading quiz…</p>';

        const { data:[quiz] } = await supa
          .from('quizzes').select('*').eq('id', id);

        let idx = 0, answers = [];

        function renderPage() {
          const q = quiz.questions[idx];
          const isFirst = idx === 0, isLast = idx === quiz.questions.length -1;
          container.innerHTML = `
            <h3>${quiz.title}</h3>
            <div class="progress">
              ${quiz.questions.map((_,i)=>`<div class="pill" id="pill${i}"></div>`).join('')}
            </div>
            <div class="question">
              <p><strong>Q${idx+1}. ${q.prompt}</strong></p>
              ${q.choices.map((c,j)=>`
                <label>
                  <input type="radio" name="choice" value="${j}"> ${c}
                </label>
              `).join('')}
            </div>
            <div>
              ${!isFirst ? '<button id="back">Back</button>' : ''}
              <button id="next">${isLast ? 'Finish' : 'Next'}</button>
            </div>
            <div id="feedback"></div>
          `;

          // Preselect
          if (answers[idx]!=null) {
            const ch = container.querySelector(`input[value="${answers[idx]}"]`);
            if (ch) ch.checked = true;
          }

          const nextBtn = container.querySelector('#next');
          const backBtn = container.querySelector('#back');
          const fb = container.querySelector('#feedback');

          // Grading mode
          if (gradingMode === 'instant') {
            nextBtn.disabled = true;
            container.querySelectorAll('input[name="choice"]').forEach(r => {
              r.onchange = () => {
                const val = +r.value;
                answers[idx] = val;
                if (val === q.correctIdx) fb.textContent = '✅ Correct';
                else fb.textContent = '❌ Incorrect';
                container.querySelector(`#pill${idx}`).classList.add(val===q.correctIdx?'correct':'incorrect');
                // disable change
                container.querySelectorAll('input').forEach(i=>i.disabled=true);
                nextBtn.disabled = false;
                if (backBtn) backBtn.disabled = true;
              };
            });
          } else {
            // review mode
            container.querySelectorAll('input[name="choice"]').forEach(r => {
              r.onchange = () => { answers[idx] = +r.value; };
            });
          }

          // Navigation
          if (backBtn) backBtn.onclick = () => { idx--; renderPage(); };
          nextBtn.onclick = () => {
            if (gradingMode==='review' && answers[idx]==null) {
              alert('Select an answer to continue.'); return;
            }
            container.querySelector(`input[name="choice"]`)?.disabled=false;
            if (idx < quiz.questions.length -1) {
              idx++; renderPage();
            } else finishQuiz();
          };
        }

        async function finishQuiz() {
          modal.style.display = 'none';
          const student = prompt('Enter your name:');
          if (!student) { alert('Name required.'); return; }
          let correct = 0;
          quiz.questions.forEach((q,i)=>{ if (answers[i]===q.correctIdx) correct++; });
          const score = `${correct} / ${quiz.questions.length}`;
          alert(`Your score: ${score}`);
          await supa.from('submissions').insert([{
            quiz_id: id, student, answers, score,
            time: new Date().toISOString()
          }]);
        }

        renderPage();
      }
    });
  </script>
</body>
</html>
