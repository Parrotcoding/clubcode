<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family:system-ui,Arial,sans-serif; margin:1rem auto; max-width:800px; }
    h1,h2 { color:#0c4a7f; }
    .link-list, .quiz-list { margin-bottom:2rem; }
    .link-item, .quiz-item { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid #eee; }
    .link-item:last-child, .quiz-item:last-child { border-bottom:none; }
    .quiz-link { cursor:pointer; color:#0366d6; text-decoration:underline; }
    .modal-backdrop {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    .modal { background:#fff; padding:2rem; max-width:600px; width:90%; max-height:90%; overflow:auto; position:relative; }
    .close-btn { position:absolute; top:.5rem; right:.5rem; cursor:pointer; }
    .progress { display:flex; gap:4px; margin-bottom:1rem; }
    .pill { flex:1; height:12px; background:#e2e8f0; border-radius:6px; }
    .pill.correct { background:#4caf50; }
    .pill.incorrect { background:#555; }
    .question { margin-bottom:1rem; }
    label { display:block; margin:.4rem 0; }
    button { padding:.5rem 1rem; margin-top:.5rem; }
  </style>
</head>
<body>
  <h1>HTML Fundamentals – Student Portal</h1>

  <section>
    <h2>Links</h2>
    <div id="links" class="link-list">Loading links…</div>
  </section>

  <section>
    <h2>Quizzes</h2>
    <div id="quizList" class="quiz-list">Loading quizzes…</div>
  </section>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <span id="closeModal" class="close-btn">✖️</span>
      <div id="quizContainer"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supa = supabase.createClient(
        'https://kqprtnxmostvagtildsn.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxcHJ0bnhtb3N0dmFndGlsZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MzkzNzcsImV4cCI6MjA2MTExNTM3N30.-vU2hAJuA7JLkRjj1iOBAN9Y0pDEr3DU4XKjEp7NOUc'
      );

      // LINKS
      const { data: links = [], error: linksErr } = await supa
        .from('links').select('title,url').eq('published', true).order('title');
      const linksDiv = document.getElementById('links');
      if (linksErr) {
        console.error('Error loading links:', linksErr);
        linksDiv.textContent = 'Failed to load links.';
      } else {
        linksDiv.innerHTML = links.length
          ? links.map(l => `
              <div class="link-item">
                <span>${l.title}</span>
                <button onclick="window.open('${l.url}','_blank')">Open ↗</button>
              </div>
            `).join('')
          : '<p>No links published.</p>';
      }

      // QUIZZES
      const { data: quizzes = [], error: quizzesErr } = await supa
        .from('quizzes').select('id,title,grading_mode').eq('published', true).order('id');
      const quizDiv = document.getElementById('quizList');
      if (quizzesErr) {
        console.error('Error loading quizzes:', quizzesErr);
        quizDiv.textContent = 'Failed to load quizzes.';
      } else {
        quizDiv.innerHTML = quizzes.length
          ? quizzes.map(q => `
              <div class="quiz-item">
                <span class="quiz-link" data-id="${q.id}" data-mode="${q.grading_mode}">
                  ${q.title}
                </span>
              </div>
            `).join('')
          : '<p>No quizzes available.</p>';
      }

      // Modal & Quiz logic (same as before)...
      const modal = document.getElementById('modalBackdrop'),
            container = document.getElementById('quizContainer');
      document.getElementById('closeModal').onclick = () => modal.style.display = 'none';
      quizDiv.querySelectorAll('.quiz-link').forEach(el =>
        el.onclick = () => runQuiz(el.dataset.id, el.dataset.mode)
      );

      async function runQuiz(id, gradingMode) {
        modal.style.display = 'flex';
        container.innerHTML = '<p>Loading…</p>';
        const { data:[quiz] } = await supa.from('quizzes').select('*').eq('id', id);
        let idx=0, answers=[], pills=[];
        function renderPage() {
          const q = quiz.questions[idx],
                isFirst = idx===0, isLast = idx===quiz.questions.length-1;
          container.innerHTML = `
            <h3>${quiz.title}</h3>
            <div class="progress">
              ${quiz.questions.map((_,i)=>`<div class="pill" id="pill${i}"></div>`).join('')}
            </div>
            <div class="question">
              <p><strong>Q${idx+1}. ${q.prompt}</strong></p>
              ${q.choices.map((c,j)=>`
                <label>
                  <input type="radio" name="choice" value="${j}" ${answers[idx]===j?'checked':''}>
                  ${c}
                </label>
              `).join('')}
            </div>
            <div>
              ${!isFirst?'<button id="back">Back</button>':''}
              <button id="next">${isLast?'Finish':'Next'}</button>
            </div>
            <div id="feedback"></div>
          `;
          // restore pill colors
          quiz.questions.forEach((_,i)=>{
            if (pills[i] != null)
              container.querySelector(`#pill${i}`).classList.add(pills[i]?'correct':'incorrect');
          });
          const nextBtn=container.querySelector('#next'),
                backBtn=container.querySelector('#back'),
                fb=container.querySelector('#feedback');

          if (gradingMode==='instant') {
            nextBtn.disabled=true;
            if (backBtn) backBtn.disabled=true;
            container.querySelectorAll('input[name="choice"]').forEach(radio=>{
              radio.onchange = ()=>{
                const val=+radio.value,
                      correct=val===q.correctIdx;
                answers[idx]=val; pills[idx]=correct;
                fb.textContent = correct?'✅ Correct':'❌ Incorrect';
                container.querySelector(`#pill${idx}`)
                  .classList.add(correct?'correct':'incorrect');
                container.querySelectorAll('input').forEach(i=>i.disabled=true);
                nextBtn.disabled=false;
              };
            });
          } else {
            container.querySelectorAll('input[name="choice"]').forEach(radio=>{
              radio.onchange=()=>answers[idx]=+radio.value;
            });
          }

          if (backBtn) backBtn.onclick=()=>{ idx--; renderPage(); };
          nextBtn.onclick=()=>{
            if (gradingMode==='review' && answers[idx]==null) {
              alert('Select an answer.'); return;
            }
            if (idx<quiz.questions.length-1) {
              idx++; renderPage();
            } else finishQuiz();
          };
        }
        async function finishQuiz(){
          modal.style.display='none';
          const student=prompt('Your name:');
          if (!student){ alert('Name required.'); return; }
          let correctCt=0;
          quiz.questions.forEach((q,i)=>{ if (answers[i]===q.correctIdx) correctCt++; });
          const score=`${correctCt}/${quiz.questions.length}`;
          alert(`Score: ${score}`);
          await supa.from('submissions').insert([{
            quiz_id:id, student, answers, score,
            time: new Date().toISOString()
          }]);
        }
        renderPage();
      }
    });
  </script>
</body>
</html>
