<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... head as before ... -->
</head>
<body>
  <!-- ... existing body ... -->

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // ... supa setup & quiz list load ...

      async function runQuiz(id, gradingMode) {
        modal.style.display = 'flex';
        container.innerHTML = '<p>Loading quiz…</p>';
        const { data: [quiz] } = await supa.from('quizzes').select('*').eq('id', id);

        // State variables
        let idx, answers, pills, studentName;

        // 1) Name entry screen
        container.innerHTML = `
          <h3>${quiz.title}</h3>
          <div>
            <label for="studentName">Your name:</label>
            <input type="text" id="studentName" placeholder="Enter your name">
            <button id="startQuiz">Start Quiz</button>
          </div>
        `;
        document.getElementById('startQuiz').onclick = () => {
          const name = document.getElementById('studentName').value.trim();
          if (!name) { alert('Please enter your name to begin.'); return; }
          studentName = name;
          idx = 0;
          answers = [];
          pills = [];
          renderPage();
        };

        // 2) Question pages
        function renderPage() {
          const q = quiz.questions[idx];
          const isFirst = idx === 0, isLast = idx === quiz.questions.length - 1;
          container.innerHTML = `
            <h3>${quiz.title}</h3>
            <div class="progress">
              ${quiz.questions.map((_,i)=>`<div class="pill" id="pill${i}"></div>`).join('')}
            </div>
            <div class="question">
              <p><strong>Q${idx+1}. ${q.prompt}</strong></p>
              ${q.choices.map((c,j)=>`
                <label>
                  <input type="radio" name="choice" value="${j}" ${answers[idx]===j?'checked':''}>
                  ${c}
                </label>
              `).join('')}
            </div>
            <div>
              ${!isFirst?'<button id="back">Back</button>':''}
              <button id="next">${isLast?'Finish':'Next'}</button>
            </div>
            <div id="feedback"></div>
          `;
          // restore pill colors
          quiz.questions.forEach((_,i)=>{
            if (pills[i] != null)
              container.querySelector(`#pill${i}`)
                       .classList.add(pills[i]?'correct':'incorrect');
          });

          const nextBtn = container.querySelector('#next'),
                backBtn = container.querySelector('#back'),
                fb = container.querySelector('#feedback');

          if (gradingMode === 'instant') {
            nextBtn.disabled = true;
            if (backBtn) backBtn.disabled = true;
            container.querySelectorAll('input[name="choice"]').forEach(radio=>{
              radio.onchange = ()=>{
                const val = +radio.value;
                const correct = val===q.correctIdx;
                answers[idx]=val; pills[idx]=correct;
                fb.textContent = correct?'✅ Correct':'❌ Incorrect';
                container.querySelector(`#pill${idx}`)
                         .classList.add(correct?'correct':'incorrect');
                container.querySelectorAll('input').forEach(i=>i.disabled=true);
                nextBtn.disabled=false;
              };
            });
          } else {
            container.querySelectorAll('input[name="choice"]').forEach(radio=>{
              radio.onchange=()=>answers[idx]=+radio.value;
            });
          }

          if (backBtn) backBtn.onclick = ()=>{ idx--; renderPage(); };
          nextBtn.onclick = ()=>{
            if (gradingMode==='review' && answers[idx]==null) {
              alert('Select an answer first.'); return;
            }
            if (idx<quiz.questions.length-1) {
              idx++; renderPage();
            } else finishQuiz();
          };
        }

        async function finishQuiz() {
          modal.style.display='none';
          const student = studentName;  // use input value
          let correctCt = 0;
          quiz.questions.forEach((q,i)=>{ if (answers[i]===q.correctIdx) correctCt++; });
          const score=`${correctCt}/${quiz.questions.length}`;
          alert(`Score: ${score}`);
          await supa.from('submissions').insert([{ 
            quiz_id:id, student, answers, score, time:new Date().toISOString() 
          }]);
        }
      }

      // ... rest of your initialization ...
    });
  </script>
</body>
</html>
