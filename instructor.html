<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instructor Dashboard</title>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family:system-ui,Arial,sans-serif; margin:1rem auto; max-width:800px; }
    h1,h2 { color:#0c4a7f; }
    .quiz-item, .question-block { border:1px solid #ddd; padding:1rem; margin-bottom:1rem }
    .quiz-item div { display:flex; justify-content:space-between; }
    button { margin:.3rem; }
    input, textarea { width:100%; margin:.4rem 0; }
    .choice { display:flex; align-items:center; }
    .choice input[type="checkbox"] { margin-right:.5rem; }
  </style>
</head>
<body>
  <h1>Instructor Dashboard</h1>

  <section>
    <h2>Existing Quizzes</h2>
    <div id="quizList">Loading…</div>
  </section>

  <section>
    <h2>Create Multi-Question Quiz</h2>
    <form id="quizForm">
      <input name="id" placeholder="Quiz ID (e.g. q5)" required>
      <input name="title" placeholder="Quiz Title" required>
      <div id="questionsContainer"></div>
      <button type="button" id="addQuestion">Add Question</button>
      <button type="submit">Save Quiz</button>
    </form>
  </section>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const SUPABASE_URL = 'https://kqprtnxmostvagtildsn.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxcHJ0bnhtb3N0dmFndGlsZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MzkzNzcsImV4cCI6MjA2MTExNTM3N30.-vU2hAJuA7JLkRjj1iOBAN9Y0pDEr3DU4XKjEp7NOUc';
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // --- Load & render existing quizzes ---
      async function loadList() {
        const res = await supa
          .from('quizzes')
          .select('*')
          .order('id', { ascending: true });
        const data = res.data || [];
        const list = document.getElementById('quizList');
        if (!data.length) {
          list.innerHTML = '<p>No quizzes yet.</p>';
          return;
        }
        list.innerHTML = data.map(q => `
          <div class="quiz-item">
            <div><strong>${q.id}</strong> — ${q.title}</div>
            <div>
              <button onclick="togglePub('${q.id}', ${!q.published})">
                ${q.published ? 'Unpublish' : 'Publish'}
              </button>
              <button onclick="deleteQuiz('${q.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      }

      // Toggle published flag
      window.togglePub = async (id, pub) => {
        await supa
          .from('quizzes')
          .update({ published: pub })
          .eq('id', id);
        loadList();
      };

      // Delete a quiz
      window.deleteQuiz = async id => {
        if (!confirm(`Really delete quiz ${id}?`)) return;
        await supa
          .from('quizzes')
          .delete()
          .eq('id', id);
        loadList();
      };

      // --- Quiz builder with checkboxes for correct answer ---
      const form = document.getElementById('quizForm');
      const container = document.getElementById('questionsContainer');
      document.getElementById('addQuestion').onclick = () => {
        const idx = container.children.length;
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `
          <input name="prompt${idx}" placeholder="Question prompt" required>
          ${[0,1,2,3].map(j=>`
            <div class="choice">
              <input type="checkbox" name="correct${idx}" value="${j}">
              <input name="choice${idx}${j}" placeholder="Choice ${j+1}" required>
            </div>
          `).join('')}
        `;
        container.appendChild(block);
      };
      document.getElementById('addQuestion').click();

      // Save quiz
      form.onsubmit = async e => {
        e.preventDefault();
        const f = new FormData(form);
        const id = f.get('id'), title = f.get('title');
        const questions = Array.from(container.children).map((blk, i) => {
          // collect prompt, choices, and correct
          const prompt = f.get(`prompt${i}`);
          const choices = [0,1,2,3].map(j => f.get(`choice${i}${j}`));
          // exactly one checkbox should be checked
          const correctIdx = Number(f.get(`correct${i}`)) || 0;
          return { prompt, choices, correctIdx };
        });
        await supa.from('quizzes').upsert([{
          id,
          title,
          questions,
          published: false
        }]);
        alert('Quiz saved. You can publish it from the list above.');
        form.reset();
        container.innerHTML = '';
        document.getElementById('addQuestion').click();
        loadList();
      };

      // Initial load
      loadList();
    });
  </script>
</body>
</html>
