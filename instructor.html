<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instructor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family:system-ui,Arial,sans-serif; margin:1rem auto; max-width:900px }
    h1,h2 { color:#0c4a7f }
    form, .resource-item { border:1px solid #ddd; padding:1rem; margin-bottom:1rem }
    .resource-item { display:flex; justify-content:space-between; align-items:center }
    .resource-item span { cursor:pointer; flex:1 }
    button { margin-left:.5rem; }
    input { width:100%; margin:.4rem 0; padding:.4rem }
    iframe { width:100%; height:400px; border:1px solid #ccc; margin-top:1rem }
  </style>
</head>
<body>
  <h1>Instructor Dashboard</h1>

  <section>
    <h2>Add Resource Link</h2>
    <form id="addResourceForm">
      <input name="id" placeholder="Resource ID (e.g. res11)" required>
      <input name="title" placeholder="Title" required>
      <input name="url" placeholder="https://example.com" required>
      <button type="submit">Add Resource</button>
    </form>
  </section>

  <section>
    <h2>Manage Resources</h2>
    <div id="resourceList">Loading…</div>
  </section>

  <section>
    <h2>Preview Resource</h2>
    <iframe id="previewFrame" src="about:blank"></iframe>
  </section>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const SUPABASE_URL = 'https://kqprtnxmostvagtildsn.supabase.co';
      const SUPABASE_KEY = 'YOUR_ANON_KEY';
      const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const listDiv = document.getElementById('resourceList');
      const preview = document.getElementById('previewFrame');

      // Load and render resources
      async function loadResources() {
        const { data = [] } = await supa
          .from('resources')
          .select('*')
          .order('title', { ascending: true });
        listDiv.innerHTML = data.map(r => `
          <div class="resource-item" data-url="${r.url}">
            <span>${r.title}</span>
            <div>
              <button onclick="togglePub('${r.id}',${!r.published})">
                ${r.published ? 'Unpublish' : 'Publish'}
              </button>
              <button onclick="deleteRes('${r.id}')">Delete</button>
              <button class="open-btn">Open ↗</button>
            </div>
          </div>
        `).join('') || '<p>No resources.</p>';

        // Attach click handlers
        document.querySelectorAll('.resource-item span').forEach(el => {
          el.onclick = () => {
            const url = el.parentElement.dataset.url;
            preview.src = url;
          };
        });
        document.querySelectorAll('.open-btn').forEach(btn => {
          btn.onclick = e => {
            e.stopPropagation();
            const url = btn.parentElement.parentElement.dataset.url;
            window.open(url, '_blank');
          };
        });
      }

      // Add resource
      document.getElementById('addResourceForm').onsubmit = async e => {
        e.preventDefault();
        const f = new FormData(e.target);
        await supa.from('resources').insert([{
          id: f.get('id'),
          title: f.get('title'),
          url: f.get('url'),
          published: false
        }]);
        e.target.reset();
        loadResources();
      };

      // Toggle publish
      window.togglePub = async (id, pub) => {
        await supa.from('resources').update({ published: pub }).eq('id', id);
        loadResources();
      };

      // Delete resource
      window.deleteRes = async id => {
        if (!confirm('Delete this resource?')) return;
        await supa.from('resources').delete().eq('id', id);
        loadResources();
      };

      // Initial load
      loadResources();
    });
  </script>
</body>
</html>
