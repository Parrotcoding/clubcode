<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instructor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family:system-ui,Arial,sans-serif; margin:1rem auto; max-width:1000px; }
    h1,h2,h3,h4 { color:#0c4a7f; }
    .list { border:1px solid #ddd; padding:1rem; margin-bottom:2rem; }
    .quiz-item, .link-item { display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px solid #eee; }
    .quiz-item:last-child, .link-item:last-child { border-bottom:none; }
    .controls button { margin-left:.3rem; }
    form { border:1px solid #ddd; padding:1rem; margin-bottom:2rem; }
    .question-block { margin-bottom:1rem; padding:1rem; border:1px solid #ccc; }
    .choice { display:flex; align-items:center; margin:.4rem 0; }
    .choice input { margin-right:.5rem; }
    input, select, button { width:100%; margin:.4rem 0; padding:.4rem; }
    button.add { width:auto; }
    table { width:100%; border-collapse:collapse; margin-top:.5rem; }
    th,td { border:1px solid #ddd; padding:.5rem; text-align:left; }
  </style>
</head>
<body>
  <h1>Instructor Dashboard</h1>

  <!-- Quizzes Management -->
  <section>
    <h2>Manage Quizzes</h2>
    <div id="quizList" class="list">Loading quizzes…</div>

    <h3>Create / Edit Quiz</h3>
    <form id="addQuiz">
      <input name="id" placeholder="Quiz ID" required>
      <input name="title" placeholder="Quiz Title" required>
      <select name="grading_mode" required>
        <option value="instant">Instant feedback</option>
        <option value="review">Review & submit</option>
      </select>
      <div id="questionsContainer"></div>
      <button type="button" id="addQuestion" class="add">Add Question</button>
      <button type="submit">Save Quiz</button>
    </form>

    <h3>Submissions</h3>
    <div id="submissionsSection" class="list">Loading submissions…</div>
  </section>

  <!-- Links Management -->
  <section>
    <h2>Manage Links</h2>
    <form id="addLink">
      <input name="id" placeholder="Link ID" required>
      <input name="title" placeholder="Title" required>
      <input name="url" placeholder="https://example.com" required>
      <button type="submit">Add Link</button>
    </form>
    <div id="linkList" class="list">Loading links…</div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supa = supabase.createClient(
        'https://kqprtnxmostvagtildsn.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxcHJ0bnhtb3N0dmFndGlsZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MzkzNzcsImV4cCI6MjA2MTExNTM3N30.-vU2hAJuA7JLkRjj1iOBAN9Y0pDEr3DU4XKjEp7NOUc'
      );

      // --- Quizzes ---

      async function loadQuizzes() {
        const { data: quizzes = [], error } = await supa
          .from('quizzes')
          .select('id,title,grading_mode,published')
          .order('id', { ascending: true });

        if (error) {
          console.error('Error loading quizzes:', error);
          document.getElementById('quizList').textContent = 'Failed to load quizzes.';
          return;
        }

        const quizList = document.getElementById('quizList');
        quizList.innerHTML = quizzes.length
          ? quizzes.map(q => `
              <div class="quiz-item">
                <div>
                  <strong>${q.id} — ${q.title}</strong> [${q.grading_mode}]
                  <button onclick="toggleQuiz('${q.id}', ${!q.published})">
                    ${q.published ? 'Unpublish' : 'Publish'}
                  </button>
                  <button onclick="deleteQuiz('${q.id}')">Delete</button>
                </div>
              </div>
            `).join('')
          : '<p>No quizzes.</p>';

        // Load submissions after quizzes
        loadSubmissions();
      }

      window.toggleQuiz = async (id, pub) => {
        await supa.from('quizzes').update({ published: pub }).eq('id', id);
        loadQuizzes();
      };
      window.deleteQuiz = async id => {
        await supa.from('quizzes').delete().eq('id', id);
        loadQuizzes();
      };

      // --- Submissions ---

      async function loadSubmissions() {
        const section = document.getElementById('submissionsSection');
        const { data: subs, error } = await supa
          .from('submissions')
          .select('quiz_id,student,score,time')
          .order('time', { ascending: false });

        if (error) {
          console.error('Error loading submissions:', error);
          section.innerHTML = '<p>Failed to load submissions.</p>';
          return;
        }
        if (!subs || subs.length === 0) {
          section.innerHTML = '<p>No submissions yet.</p>';
          return;
        }

        // Group by quiz_id
        const grouped = subs.reduce((acc, s) => {
          (acc[s.quiz_id] = acc[s.quiz_id] || []).push(s);
          return acc;
        }, {});

        // Render groups
        section.innerHTML = Object.entries(grouped).map(([quizId, list]) => `
          <h4>Quiz ${quizId}</h4>
          <table>
            <thead>
              <tr><th>Student</th><th>Score</th><th>Time</th></tr>
            </thead>
            <tbody>
              ${list.map(s => `
                <tr>
                  <td>${s.student}</td>
                  <td>${s.score}</td>
                  <td>${new Date(s.time).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `).join('');
      }

      // --- Quiz Builder ---

      const qForm = document.getElementById('addQuiz');
      const qCont = document.getElementById('questionsContainer');

      document.getElementById('addQuestion').onclick = () => {
        const i = qCont.children.length;
        const blk = document.createElement('div');
        blk.className = 'question-block';
        blk.innerHTML = `
          <input name="prompt${i}" placeholder="Prompt" required>
          ${[0,1,2,3].map(j => `
            <div class="choice">
              <input type="checkbox" name="correct${i}" value="${j}">
              <input name="choice${i}${j}" placeholder="Choice ${j+1}" required>
            </div>
          `).join('')}
        `;
        qCont.appendChild(blk);
      };

      // start with one question block
      document.getElementById('addQuestion').click();

      qForm.onsubmit = async e => {
        e.preventDefault();
        const f = new FormData(qForm);
        const id    = f.get('id');
        const title = f.get('title');
        const mode  = f.get('grading_mode');
        const questions = Array.from(qCont.children).map((blk, i) => ({
          prompt:    f.get(`prompt${i}`),
          choices:   [0,1,2,3].map(j => f.get(`choice${i}${j}`)),
          correctIdx: Number(f.get(`correct${i}`)) || 0
        }));

        await supa.from('quizzes').upsert([{
          id, title, grading_mode: mode, questions, published: false
        }]);

        qForm.reset();
        qCont.innerHTML = '';
        document.getElementById('addQuestion').click();
        loadQuizzes();
      };

      // --- Links Management ---

      async function loadLinks() {
        const { data: links = [], error } = await supa
          .from('links').select('*').order('title');
        const div = document.getElementById('linkList');
        if (error) {
          console.error('Error loading links:', error);
          div.textContent = 'Failed to load links.';
          return;
        }
        div.innerHTML = links.length
          ? links.map(l => `
              <div class="link-item">
                <span>${l.title}</span>
                <div class="controls">
                  <button onclick="toggleLink('${l.id}', ${!l.published})">
                    ${l.published ? 'Unpublish' : 'Publish'}
                  </button>
                  <button onclick="deleteLink('${l.id}')">Delete</button>
                  <button onclick="window.open('${l.url}','_blank')">Open ↗</button>
                </div>
              </div>
            `).join('')
          : '<p>No links.</p>';
      }

      window.toggleLink = async (id, pub) => {
        await supa.from('links').update({ published: pub }).eq('id', id);
        loadLinks();
      };
      window.deleteLink = async id => {
        await supa.from('links').delete().eq('id', id);
        loadLinks();
      };

      document.getElementById('addLink').onsubmit = async e => {
        e.preventDefault();
        const f = new FormData(e.target);
        await supa.from('links').insert([{
          id:    f.get('id'),
          title: f.get('title'),
          url:   f.get('url'),
          published: false
        }]);
        e.target.reset();
        loadLinks();
      };

      // initial load
      loadQuizzes();
      loadLinks();
    });
  </script>
</body>
</html>
